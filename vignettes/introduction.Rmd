---
title: "Introducing gen3sis"
date: "`r format(Sys.time(),  '%d.%m.%Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introducing gen3sis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  tidy=T,
  fig.align='center',
  tidy.opts = list(width.cutoff=100),
  results='hold'
)
```
Hello and welcome! In this vignette you will be introduced to gen3sis, an engine for simulating various spatial eco-evolutionary models. We will create a virtual planet, 'biodiversify' it and examine some brand new virtual species.

Thus we will: 

1. **Start** gen3sis package and check if we are set with all the necessary input data.
2. **Run** one simple example simulation
3. **Visualize** the output
4. **Analyze** the output


----

The first step for running a simulation consists of setting up the folder structure with the required input data from which the landscape object and the distance matrices are calculated. 
Thereafter, the function run_simulation, our main function, will:

1) Read in the config and prepare the output directories, initial landscape and call “create_ancestor_species” from the user config to create the initial species for the simulation.

2) Start the main loop over the time steps. For every time step it loads the appropriate landscape, removes all cells that became uninhabitable in the new time step, and calls the main steps of any iteration.

3) At the end of every time step the simulation saves the species richness pattern, the phylogeny, if desired the species and landscape, and calls the “end_of_timestep_observer” function from the user config. In this function the user can implement customized observer functions, for example calculating summary statistics or creating species patterns plots.


Additionally to the main functions, the package provides several convenience functions to generate input data, configuration files, and plottings. Moreover, all functions are accessible  to the observer functions, which requests the variables for calculation during the model runs. This allows to transform the output of the simulation model into a format that can be readily analysed. The model is implemented in a mix of R and C++ code, and wrapped into an R package. All high-level functions that the user may use to interact with are written in R, and are documented via the standard R / Roxygen help files for R packages. Runtime-critical functions are implemented in C++ and coupled to R via the Rcpp framework. 

----


## 1. Start
First of all, we need to load the gen3sis package 
```{r setup}
library(gen3sis)
```


Perfect! From now on, if you run into problems, use *>??gen3sis* for the full help documentation

Let's check the version of the gen3sis package we are using

```{r eval=TRUE}
print(paste("GEN3SIS version:", packageVersion("gen3sis")))
```



All gen3sis simulations need a **landscape** and a **configuration** object to refer to. The **landscape** is the environment of the virtual planet (e.g. temperature and precipitation data that changes spatially and temporally). The **configuration** are the rules of our virtual planet, here is were we define all the ecological and evolutionary equations and parameters.
Here we will use a published small theoretical planet example[^1]. 

Since this is a small data (252 KB) which is already available in the package, you can just get the path to the data inside the package. This [landscape](https://github.com/project-Gen3sis) and [configuration](https://github.com/project-Gen3sis) data can also be downloaded manually and stored locally for running the experiment.

 Like this:

|>EXPERIMENT_FOLDER     |
|:-------------------------|
|&nbsp;&nbsp;&nbsp;**>landscape**|
|&nbsp;&nbsp;&nbsp;**>config**|

```{r eval=TRUE}
datapath <- system.file(file.path("extdata", "WorldCenter"), package="gen3sis")
```



**NOTE** that the landscape contains several files. The .rds file has the landscape changing over time and the distances folder stores some data to inform how the landscape (or more precisely that habitable cells) is connected. In this example you are using an already ready-to-run landscape. To see how to create a landscape object, see (this vignette)[create_landscape.html]

You should now have downloaded all the necessary files to run a simulation. 


[^1]: O. Hagen, B. Flück, F. Fopp, J.S. Cabral, F. Hartig, M. Pontarp, T.F. Rangel, L. Pellissier. (2020). GENƎSIS: the GENeral Engine for Eco-Evolutionary SImulationS on the origins of biodiversity. (in prep)


## 2. Run

To launch a simulation you need to call the run_simulation function.

```{r eval=F, echo=TRUE}
#we set verbose to 0 to avoid a large console outputs of how the simulation is developping
sim <- run_simulation(config = file.path(datapath, "config/config_worldcenter.R"), 
               landscape = file.path(datapath, "landscape"),
               save_intermediate_results = "all",
               verbose=0)
```

```{r eval=T, echo=F}
sim <- readRDS(file.path(datapath, "output/config_worldcenter/summary_sim.rds"))
```

After the simulation is finished, a plot is created inside the CaseStudy1 folder to show the state of the initial world. As you can see it contains 1 species per cell in the 20*40 cell sample world.

Excellent. Our virtual species are waiting for us. They are automatically stored in a sub folder called **output** inside our CaseStudy1 folder and inside another folder named after our configuration file (i.e. config). It should look like this:

|>EXPERIMENT_FOLDER     |
|:-------------------------|
|&nbsp;&nbsp;&nbsp;>landscape|
|&nbsp;&nbsp;&nbsp;>config|
|&nbsp;&nbsp;&nbsp;**>output**|

## 3. Visualize

Gen3sis also creates a summary object at the end of the simulation storing some default observer functions. These are summaries that document the changes of the world over time.
**NOTE** You can also create your own observer function. 

One default observer function is the collection of the richness over time. This was stored as 'sim'.
We can quickly visualize some main results using the plot_summary function.


```{r eval=TRUE, fig.width=7, fig.height=7}
plot_summary(sim)
```


There are a few visualization tools already included in the package, but you are free to explore and check the outputs with your favorite plotting functions and colors. To look at the landscape and species richness at the end of the simulation (i.e. present, aka 0Ma), we first have to load the respective species and landscape object.


```{r eval=TRUE, fig.width=5, fig.height=5}
library(raster)
richness_t0 <- rasterFromXYZ(sim$summary$`richness-final`)
plot(richness_t0, main='richness t0')
```

## 4. Analyze

Let's see how species richness correlates with both environmental variables at the present.

```{r eval=TRUE, fig.width=8, fig.height=5, fig.retina=2}
landscapes <- readRDS(file.path(datapath, "landscape", "landscapes.rds")) #get the input landscape
landscape_t0 <- as.data.frame(cbind(landscapes$temp[, 1:2], temp=landscapes$temp[, 3], prec=landscapes$prec[,3], area=landscapes$area[,3])) #get landscape at last timestep
landscape_t0 <- cbind(landscape_t0, rich=sim$summary$`richness-final`[,3]) #add richness to the dataframe
landscape_t0 <- na.omit(landscape_t0)

# create a table and order by richness
#landscape_t0 <- landscape_t0[order(landscape_t0$rich),]

par(mfrow=c(1,3))
#plot richness against temperature
plot(landscape_t0$temp, landscape_t0$rich, xlab='temperature', ylab='richness', pch=16, col=rgb(0,0,0,0.5))
#plot richness against precipitation
plot(landscape_t0$prec, landscape_t0$rich, xlab='precipitation', ylab='richness', pch=16, col=rgb(0,0,0,0.5))
#plot richness against area
plot(landscape_t0$area, landscape_t0$rich, xlab='area', ylab='richness', pch=16, col=rgb(0,0,0,0.5))

```



Much is possible here, from looking at phylogenies to spatial correlations. For this introduction we will keep things simple and look at the correlation between richness and environmental variables.


```{r eval=TRUE, fig.width=8, fig.height=7, fig.retina=2}
glm.uni <- glm(rich ~ poly(temp, 2), data=landscape_t0, family=poisson)

#Plot the response curve
par(mfrow=c(1,1))
data_plot <- data.frame(cbind(landscape_t0$temp, predict(glm.uni,type = "response")))
sort1 <- na.omit(data_plot[order(data_plot[,1], decreasing = FALSE),])
data_plot <- data.frame(cbind(sort1[,1],sort1[,2]))
plot(data_plot[,1],data_plot[,2], xlab="Temperature", ylab="Species richness", frame.plot=F, type="l")
#Plot the presences in red and absences in blue
points(landscape_t0$temp, landscape_t0$rich, col=rgb(0.5,0.5,0.5, alpha=0.4), pch=16) 
legend(5,20, col=c(rgb(0.5,0.5,0.5,0.4), 'black'), legend=c('obersvations', 'model fit'), pch=c(16, NA), lty=c(NA, 1))

```


```{r eval=TRUE}
richness_model <- glm(rich ~ poly(temp, 2) + poly(prec, 2) + poly(area, 2), family='quasipoisson', data=landscape_t0)
summary(richness_model)
```
The 'virtual' world is now yours! Enjoy.