---
title: "Introducing gen3sis"
date: "`r format(Sys.time(),  '%d.%m.%Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introducing gen3sis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
Hello and wellcome! In this vignette you will be introduced to gen3sis, an engine for simulating various spatial eco-evolutionary models. We will create an virtual planet, 'biodiversify' it and examine some brand new virtual species.

Thus we will: 

1. **Start** gen3sis package and check if we are set with all the necessary input data.
2. **Run** one simple example simulation
3. **Visualize** the output
4. **Analize** the output


----

The first step for running a  simulation consists of setting up the folder structure with the required input data from which the landscape object and the distance matrices are calculated. 
Thereafter, the funciton run_simulation, our main function, will:
1) Read in the config and prepare the output directories, initial landscape and call “create_initial_species” from the user config to create the initial species for the simulation.
2) Start  the main loop over the time steps. For every time step it loads the appropriate landscape, removes all cells that became uninhabitable in the new time step, and calls the main steps of any iteration.
3) At the end of every time step the simulation saves the species richness pattern, the phylogeny, if desired the species and landscape, and calls the “end_of_timestep_observer” function from the user config. In this function the user can implement  customized observer functions, for example calculating summary statistics or creating species patterns plots..

Additionally to the main functions, the package provides several convenience functions to generate input data,configuration files, and plottings. Moreover, all functions are accessible  to the observer functions, which requests the variables for calculation during the model runs. This allows to transform the output of the simulation model into a format that can be readily analysed. The model is implemented in a mix of R and C++ code, and wrapped into an R package. All high-level functions that the user may use to interact with are written in R, and are documented via the standard R / Roxygen help files for R packages. Runtime-critical functions are implemented in C++ and coupled to R via the Rcpp framework. 

----


## 1. Start
First of all, we need to load the gen3sis package 
```{r setup}
library(gen3sis)
```


Perfect! From now on, if you run into problems, use *>??gen3sis* for the full help documentation

Let's check the version of the gen3sis package we are using

```{r eval=TRUE}
print(paste("GEN3SIS version:", packageVersion("gen3sis")))
```



All gen3sis simulations need a **landscape** and a **configuration** object to refer to. The **landscape** is the environment of the virtual planet (e.g. temperature and precipitation data that changes spatialy and temporaly). The **configuration** are the rules of our virtual planet, here is were we define all the ecological and evolutionary 
Here we will use a published small theoretical planet example[^1]. 

Since this is a small data (252 KB), we made it already avaiable in the package. Get the path to the data inside the package. This data can also be downloaded the [landscape](https://github.com/project-Gen3sis) and the [configuration](https://github.com/project-Gen3sis) and store  in a prefered place wherever you would like to run the experiment.

 Like this:

|>MY_EXPERIMENT_FOLDER     |
|:-------------------------|
|&nbsp;&nbsp;&nbsp;**>landscape**|
|&nbsp;&nbsp;&nbsp;**>config**|

```{r eval=TRUE}
datapath <- system.file(file.path("extdata", "EXPERIMENT_X"), package="gen3sis")
```



**NOTE** that the landscape contain several files. The .rds file has the landscape changing over time and the distances folder stores some data to inform the landscape is connected. In this example you are using an already ready to run landscape. To see how to create a landscape object, see (this vigenette)[create_landscape.html]

Done? Great now you have downloaded all the needed files to run a simulation. 


[^1]: O. Hagen, B. Flüch, F. Fopp, J.S. Cabral, F. Hartig, M. Pontarp, T.F. Rangel, L. Pellissier. (2020). GENƎSIS: the GENeral Engine for Eco-Evolutionary SImulationS on the origins of biodiversity. (in prep)


## 2. Run

To launch our simulation use 

```{r eval=TRUE, echo=TRUE}
#we set verbose to 0 to avoid a large console outputs of how the simulation is developping
run_simulation(config_file = file.path(datapath,"config/config.R"), input_directory = file.path(datapath,"landscape"), verbose=0)

```

After the simulation is finished, a plot is created at the EXPERIMENT_X folder to show the state of the initial world. We see, 1 species per cell in the 4 cell small island.

Excellent. Our virtual species are waiting for us. They are automatically stored in a subfolder called output inside our EXPERIMENT_X folder named after our configuration file (i.e. config). Like this:

|>MY_EXPERIMENT_FOLDER     |
|:-------------------------|
|&nbsp;&nbsp;&nbsp;>landscape|
|&nbsp;&nbsp;&nbsp;>config|
|&nbsp;&nbsp;&nbsp;**>output**|

## 3. Visualize
There are a few visualization tools already included in the package, but you are free to explore and check the outputs with your favorit plotting functions and colors. For us to look at the landscape and species richness at the end of the simulation (i.e. present, aka 0Ma) first we have to load the respective species and landscape object.

```{r eval=TRUE}
#load landscape at 0Ma
l0 <- readRDS(file.path(datapath, "output/config/landscapes/landscape_t_0.rds"))
#load species at 0Ma
sps0 <- readRDS(file.path(datapath, "output/config/species/species_t_0.rds"))
```

We can then plot the environment
```{r eval=TRUE, fig.width = 5.5}
#plot all environmental values in the landscapes (in our case temperature and precipitation) at the selected timeteps (here present)
plot_landscape(l0)

```

And the richness

```{r eval=TRUE}
plot_richness(sps0, l0)
```

## 4. Analize

Let's see how species richness correlates with bouth environmental variables at the present.

```{r eval=TRUE}
rich <- gen3sis:::get_geo_richness(sps0, l0) #get species richness with cell id as name
temp <- l0$environment[,"temp"] #get temperatures values
prec <- l0$environment[,"prec"] #get precipitation values
# create a table and order by richness
data <- data.frame(rich, temp, prec)[order(rich),]
data
#plot richness against temperature
plot(data$rich, data$temp  )
#plot richness against precipitation
plot(data$rich, data$prec  )

```

Gen3sis also creates a summary object at the end of the simulation storing some default observer functions. These are summaries that look t the world as it develops.
**NOTE** You can also creat your own observer function. 
One default observer function is the collection of the richness over time. This is stored at the sgen3sis.Rdata object at the output folder.

```{r eval=TRUE}
# TOADD a plot of richenss over time
load(file.path(datapath, "output/config/sgen3sis.RData"))
#get total richness per time interval
rt <- colSums(sgen3sis$geo_richness[,-c(1,2)], na.rm = T)
#plot
plot(rt, type='l')
```


Much is possible here, from looking at phylogenies to spatial correlation. For this intro we will keep things simple and look at the correlation between richness and environmental variables.

```{r eval=TRUE}
summary(lm(rich~temp+prec, data))
```
The 'virtual' world is now yours! Enjoy.